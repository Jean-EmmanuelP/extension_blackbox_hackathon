<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analytics v2</title>
    
    <!-- Chart.js Local -->
    <script src="chart.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Design Noir et Blanc -->
    <link rel="stylesheet" href="popup-styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div>
                    <h1>
                        Financial Analytics
                        <span class="version-badge">v2</span>
                    </h1>
                    <div class="subtitle">Powered by Blackbox AI</div>
                </div>
            </div>
            <button class="refresh-btn" id="refreshBtn">↻ Actualiser</button>
        </div>

        <!-- Barre de recherche principale toujours visible -->
        <div class="main-search-bar" id="mainSearchBar">
            <div class="main-search-wrapper">
                <input type="text" 
                       id="mainQueryInput" 
                       placeholder="🔍 Posez une question sur vos données financières..." 
                       class="main-query-input"
                       autocomplete="off">
                <button id="mainSearchBtn" class="main-search-btn">Analyser</button>
            </div>
            <div class="quick-questions-row">
                <button class="quick-q-btn" data-question="Quelle est ma plus grosse dépense ?">💸 Plus grosse dépense</button>
                <button class="quick-q-btn" data-question="Quel est mon profit ?">💰 Profit</button>
                <button class="quick-q-btn" data-question="Top 5 dépenses ?">📊 Top 5</button>
                <button class="quick-q-btn" data-question="Evolution mensuelle ?">📈 Tendance</button>
                <button class="quick-q-btn" data-question="Mes salaires ?">👥 Salaires</button>
            </div>
        </div>
        
        <!-- Response de la recherche principale -->
        <div class="main-search-response" id="mainSearchResponse" style="display: none;"></div>

        <!-- Auto Sheet Info -->
        <div class="auto-sheet-info" id="sheetInfo" style="display: none;">
            <div class="sheet-status">
                <div class="sheet-indicator"></div>
                <span>Sheet actif: <span class="sheet-id" id="sheetId"></span></span>
            </div>
            <div class="auto-load-badge">AUTO</div>
        </div>

        <!-- Loader -->
        <div class="loader-container" id="loaderContainer" style="display: none;">
            <div class="loader-content">
                <div class="loader-spinner"></div>
                <div class="loader-text">Chargement des données...</div>
                <div class="loader-steps">
                    <div class="loader-step" id="loaderStep1">
                        <span class="step-icon">📊</span>
                        <span class="step-text">Connexion au Google Sheet</span>
                    </div>
                    <div class="loader-step" id="loaderStep2">
                        <span class="step-icon">🔍</span>
                        <span class="step-text">Analyse des données</span>
                    </div>
                    <div class="loader-step" id="loaderStep3">
                        <span class="step-icon">🤖</span>
                        <span class="step-text">Génération des insights IA</span>
                    </div>
                    <div class="loader-step" id="loaderStep4">
                        <span class="step-icon">📈</span>
                        <span class="step-text">Préparation du rapport</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Interface de chat améliorée -->
            <div class="chat-interface" id="chatInterface" style="display: none;">
                <div class="chat-header">
                    <span class="chat-icon">🤖</span>
                    <span class="chat-title">Assistant Financier IA</span>
                    <span class="chat-subtitle">Posez vos questions en langage naturel</span>
                </div>
                <div class="chat-suggestions">
                    <button class="suggestion-chip" data-question="Quelle est ma plus grosse dépense ?">💸 Plus grosse dépense</button>
                    <button class="suggestion-chip" data-question="Quel est mon bénéfice ce mois ?">💰 Bénéfice du mois</button>
                    <button class="suggestion-chip" data-question="Combien j'ai dépensé en salaires ?">👥 Dépenses salaires</button>
                    <button class="suggestion-chip" data-question="Quelle est ma marge ?">📈 Ma marge</button>
                    <button class="suggestion-chip" data-question="Quelles sont mes top 3 dépenses ?">🔝 Top 3 dépenses</button>
                    <button class="suggestion-chip" data-question="Evolution mois par mois ?">📅 Evolution mensuelle</button>
                </div>
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        id="queryInput" 
                        placeholder="Posez votre question... Ex: Quelle est ma plus grosse dépense ?"
                        autocomplete="off"
                    />
                    <button id="searchBtn" title="Envoyer">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
                <div class="chat-response" id="chatResponse" style="display: none;"></div>
            </div>
            
            <!-- Ancienne barre de recherche (masquée) -->
            <div class="search-container" id="oldSearchContainer" style="display: none;">
                <input type="text" id="oldQueryInput" placeholder="Recherche SQL..." />
                <button id="oldSearchBtn">Rechercher</button>
            </div>

            <!-- Résultats de requête -->
            <div class="query-results" id="queryResults" style="display: none;">
                <div class="results-header">
                    <span class="results-title">Résultats</span>
                    <span class="results-count" id="resultsCount"></span>
                </div>
                <div class="results-content" id="resultsContent"></div>
            </div>

            <!-- Métriques -->
            <div class="metrics-grid" id="metricsGrid">
                <!-- Les métriques seront insérées ici -->
            </div>

            <!-- Graphique Donut central -->
            <div class="revenue-split-container" id="revenueSplitContainer" style="display: none;">
                <div class="chart-title">Répartition des revenus</div>
                <div class="revenue-split-wrapper">
                    <div class="donut-chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                        <div class="donut-center-text">
                            <div class="donut-center-value" id="totalRevenue">-</div>
                            <div class="donut-center-label">Total</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Système d'onglets pour analyse détaillée -->
            <div class="tabs-container" id="tabsContainer" style="display: none;">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="overview">📊 Vue d'ensemble</button>
                    <button class="tab-btn" data-tab="revenue">💰 Revenus</button>
                    <button class="tab-btn" data-tab="expenses">💸 Dépenses</button>
                    <button class="tab-btn" data-tab="profitability">📈 Rentabilité</button>
                    <button class="tab-btn" data-tab="cashflow">💵 Trésorerie</button>
                    <button class="tab-btn" data-tab="trends">📉 Tendances</button>
                    <button class="tab-btn" data-tab="query">🔍 Requêtes</button>
                </div>
                
                <div class="tabs-content">
                    <!-- Onglet Vue d'ensemble -->
                    <div class="tab-panel active" id="tab-overview">
                        <!-- Contenu sera ajouté dynamiquement -->
                    </div>
                    
                    <!-- Onglet Revenus -->
                    <div class="tab-panel" id="tab-revenue">
                        <!-- Analyse détaillée des revenus -->
                    </div>
                    
                    <!-- Onglet Dépenses -->
                    <div class="tab-panel" id="tab-expenses">
                        <!-- Analyse détaillée des dépenses -->
                    </div>
                    
                    <!-- Onglet Rentabilité -->
                    <div class="tab-panel" id="tab-profitability">
                        <!-- Analyse de rentabilité -->
                    </div>
                    
                    <!-- Onglet Trésorerie -->
                    <div class="tab-panel" id="tab-cashflow">
                        <!-- Analyse de trésorerie -->
                    </div>
                    
                    <!-- Onglet Tendances -->
                    <div class="tab-panel" id="tab-trends">
                        <!-- Graphique de tendances amélioré -->
                    </div>
                    
                    <!-- Onglet Query -->
                    <div class="tab-panel" id="tab-query">
                        <div class="query-interface">
                            <div class="query-header">
                                <h3>🔍 Interroger vos données</h3>
                                <p>Posez des questions en langage naturel sur vos données financières</p>
                            </div>
                            
                            <div class="query-suggestions">
                                <button class="query-suggestion-chip" data-query="Quelle est ma plus grosse dépense ?">💸 Plus grosse dépense</button>
                                <button class="query-suggestion-chip" data-query="Quel est mon profit ce mois ?">💰 Profit mensuel</button>
                                <button class="query-suggestion-chip" data-query="Montre-moi le top 5 des dépenses">📊 Top 5 dépenses</button>
                                <button class="query-suggestion-chip" data-query="Quelle est ma tendance de revenus ?">📈 Tendance revenus</button>
                                <button class="query-suggestion-chip" data-query="Combien je dépense en salaires ?">👥 Masse salariale</button>
                            </div>
                            
                            <div class="query-input-wrapper">
                                <input type="text" id="queryTabInput" class="query-tab-input" placeholder="Ex: Quel est mon burn rate mensuel ?">
                                <button id="queryTabBtn" class="query-tab-btn">Analyser</button>
                            </div>
                            
                            <div id="queryTabResults" class="query-tab-results" style="display: none;">
                                <!-- Les résultats s'afficheront ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphique de tendance avec sélecteur de période -->
            <div class="chart-container" id="trendContainer" style="display: none;">
                <div class="chart-header">
                    <div class="chart-title">Évolution des métriques</div>
                    <div class="period-selector">
                        <button class="period-btn" data-period="day">Jour</button>
                        <button class="period-btn active" data-period="month">Mois</button>
                        <button class="period-btn" data-period="year">Année</button>
                    </div>
                </div>
                <div class="trend-explanation" id="trendExplanation">
                    <!-- Explication de la tendance sera ajoutée ici -->
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="trend-insights" id="trendInsights">
                    <!-- Insights sur la tendance seront ajoutés ici -->
                </div>
            </div>

            <!-- Insights IA -->
            <div class="insights-section" id="insightsSection" style="display: none;">
                <div class="insights-title">
                    <span>🤖</span>
                    Insights IA
                </div>
                <div id="insightsContainer">
                    <!-- Les insights seront insérés ici -->
                </div>
            </div>

            <!-- Top 3 Recommandations avec données -->
            <div class="top-recommendations-section" id="topRecommendationsSection" style="display: none;">
                <div class="recommendations-title">
                    <span>🎯</span>
                    Top 3 Actions Prioritaires
                </div>
                <div id="topRecommendationsContainer" class="recommendations-grid">
                    <!-- Les top 3 recommandations seront insérées ici -->
                </div>
            </div>

            <!-- État vide -->
            <div class="no-data" id="noDataState">
                <div class="no-data-icon">📊</div>
                <div class="no-data-text">Ouvrez un Google Sheet pour commencer</div>
                <div class="no-data-subtext">L'analyse démarrera automatiquement</div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            <div class="status-text">
                <div class="status-spinner" id="statusSpinner"></div>
                <span id="statusText">Chargement...</span>
            </div>
            <div class="agent-indicators">
                <div class="agent-dot">
                    <div class="agent-dot-indicator" id="parserDot"></div>
                    <span>Parser</span>
                </div>
                <div class="agent-dot">
                    <div class="agent-dot-indicator" id="analystDot"></div>
                    <span>Analyst</span>
                </div>
                <div class="agent-dot">
                    <div class="agent-dot-indicator" id="reporterDot"></div>
                    <span>Reporter</span>
                </div>
            </div>
        </div>
    </div>

    <script src="popup.js"></script>
</body>
</html>